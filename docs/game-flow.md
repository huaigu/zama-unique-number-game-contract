# å”¯ä¸€æ•°å­—æ¸¸æˆæµç¨‹æ–‡æ¡£ (Unique Number Game Flow)

## æ¸¸æˆæ¦‚è¿°

å”¯ä¸€æ•°å­—æ¸¸æˆæ˜¯åŸºäº Zama FHEVM å®Œå…¨åŒæ€åŠ å¯†æŠ€æœ¯çš„åŒºå—é“¾æ¸¸æˆã€‚ç©å®¶æäº¤åŠ å¯†çš„æ•°å­—ï¼Œç³»ç»Ÿåœ¨ä¸è§£å¯†çš„æƒ…å†µä¸‹è®¡ç®—å‡ºè·èƒœè€…ï¼Œç¡®ä¿æ¸¸æˆè¿‡ç¨‹çš„å…¬å¹³æ€§å’Œéšç§æ€§ã€‚

## æ¸¸æˆæ ¸å¿ƒæœºåˆ¶

### ğŸ¯ æ¸¸æˆç›®æ ‡
ç©å®¶éœ€è¦æäº¤ä¸€ä¸ªåœ¨æŒ‡å®šèŒƒå›´å†…çš„**å”¯ä¸€æ•°å­—**ã€‚å¦‚æœåªæœ‰ä¸€ä¸ªç©å®¶é€‰æ‹©äº†æŸä¸ªæ•°å­—ï¼Œè¯¥ç©å®¶è·èƒœå¹¶èµ¢å¾—å¥–æ± ã€‚

### ğŸ”‘ å…³é”®ç‰¹æ€§
- **å®Œå…¨éšç§**: ä½¿ç”¨ FHE æŠ€æœ¯ï¼Œæ‰€æœ‰æ•°å­—åœ¨æ¸¸æˆè¿‡ç¨‹ä¸­ä¿æŒåŠ å¯†çŠ¶æ€
- **å…¬å¹³ç«äº‰**: æ— äººèƒ½æå‰çŸ¥é“å…¶ä»–ç©å®¶é€‰æ‹©çš„æ•°å­—
- **è‡ªåŠ¨æ‰§è¡Œ**: æ™ºèƒ½åˆçº¦è‡ªåŠ¨å¤„ç†æ¸¸æˆé€»è¾‘å’Œå¥–åŠ±åˆ†å‘

## æ¸¸æˆç”Ÿå‘½å‘¨æœŸ

### 1. æ¸¸æˆåˆ›å»ºé˜¶æ®µ (Game Creation)

**åˆ›å»ºè€…è®¾ç½®æ¸¸æˆå‚æ•°**:
```typescript
createGame(
  roomName: string,      // æˆ¿é—´åç§° (1-64å­—ç¬¦)
  minNumber: number,     // æœ€å°æ•°å­—
  maxNumber: number,     // æœ€å¤§æ•°å­— (èŒƒå›´ä¸è¶…è¿‡255)
  maxPlayers: number,    // æœ€å¤§ç©å®¶æ•° (â‰¥2)
  entryFee: bigint,      // å…¥åœºè´¹ç”¨ (ETH)
  deadlineDuration: number // æˆªæ­¢æ—¶é—´ (ç§’)
)
```

**æ¸¸æˆçŠ¶æ€**: `Open` (å¼€æ”¾çŠ¶æ€)

**äº‹ä»¶è§¦å‘**: `GameCreated`

### 2. ç©å®¶å‚ä¸é˜¶æ®µ (Player Participation)

**ç©å®¶æäº¤åŠ å¯†æ•°å­—**:
```typescript
submitNumber(
  gameId: number,
  encryptedNumber: Handle,    // FHEåŠ å¯†çš„æ•°å­—
  inputProof: bytes,          // é›¶çŸ¥è¯†è¯æ˜
  { value: entryFee }         // å…¥åœºè´¹
)
```

**å‚ä¸æ¡ä»¶**:
- âœ… æ”¯ä»˜æ­£ç¡®çš„å…¥åœºè´¹
- âœ… åœ¨æˆªæ­¢æ—¶é—´å‰æäº¤
- âœ… æœªæ›¾æäº¤è¿‡æ•°å­—
- âœ… æ¸¸æˆçŠ¶æ€ä¸º `Open`
- âœ… æœªè¾¾åˆ°æœ€å¤§ç©å®¶æ•°é™åˆ¶

**äº‹ä»¶è§¦å‘**: `SubmissionReceived`

### 3. æ¸¸æˆç»“æŸè§¦å‘æ¡ä»¶

æ¸¸æˆæœ‰ä¸¤ç§ç»“æŸæ–¹å¼ï¼š

#### æ–¹å¼ä¸€ï¼šè¾¾åˆ°æœ€å¤§ç©å®¶æ•° ğŸ
```typescript
// å½“æäº¤çš„ç©å®¶æ•°è¾¾åˆ° maxPlayers æ—¶è‡ªåŠ¨è§¦å‘
if (playerCount == maxPlayers) {
    status = GameStatus.Calculating;
    // è§¦å‘ FHE è®¡ç®—è¯·æ±‚
    requestWinnerCalculation();
}
```

#### æ–¹å¼äºŒï¼šæˆªæ­¢æ—¶é—´åˆ°è¾¾ â°
```typescript
// ä»»ä½•äººéƒ½å¯ä»¥åœ¨æˆªæ­¢æ—¶é—´åæ‰‹åŠ¨è§¦å‘
findWinnerByDeadline(gameId) external {
    require(block.timestamp > games[gameId].deadline, "Deadline has not passed yet");
    require(games[gameId].playerCount > 0, "No players in the game");
    
    games[gameId].status = GameStatus.Calculating;
    requestWinnerCalculation();
}
```

### 4. è·èƒœè€…è®¡ç®—é˜¶æ®µ (Winner Calculation)

**æ¸¸æˆçŠ¶æ€**: `Calculating`

**ğŸ¯ ä¼˜åŒ–åçš„FHEè®¡ç®—è¿‡ç¨‹**:
1. **æ‰¹é‡è§£å¯†**: ä¸€æ¬¡æ€§è§£å¯†æ‰€æœ‰ç©å®¶æäº¤çš„åŠ å¯†æ•°å­—
2. **æ˜æ–‡è®¡ç®—**: åœ¨è§£å¯†åçš„æ•°ç»„ä¸­è¿›è¡Œé«˜æ•ˆè®¡ç®—
   - ç»Ÿè®¡æ¯ä¸ªæ•°å­—çš„å‡ºç°é¢‘æ¬¡
   - æ‰¾å‡ºæ‰€æœ‰å”¯ä¸€æ•°å­—ï¼ˆå‡ºç°æ¬¡æ•°=1ï¼‰
   - åœ¨å”¯ä¸€æ•°å­—ä¸­é€‰æ‹©æœ€å°å€¼
   - é€šè¿‡ç´¢å¼•ç›´æ¥è·å¾—è·èƒœè€…åœ°å€

**è®¡ç®—é€»è¾‘ç¤ºä¾‹**:
```javascript
è§£å¯†ç»“æœ: [3, 5, 3, 7, 5] // å¯¹åº”ç©å®¶ [A, B, C, D, E]
ç»Ÿè®¡é¢‘æ¬¡: {3: 2, 5: 2, 7: 1}
å”¯ä¸€æ•°å­—: [7] 
æœ€å°å”¯ä¸€: 7
è·èƒœè€…ç´¢å¼•: 3 (æ•°å­—7åœ¨åŸæ•°ç»„çš„ä½ç½®)
è·èƒœè€…: gamePlayerAddresses[3] = ç©å®¶D
```

**ä¼˜åŠ¿**:
- âš¡ **æ€§èƒ½æœ€ä¼˜**: åªéœ€1æ¬¡FHEè§£å¯†æ“ä½œ
- ğŸ§® **é€»è¾‘ç®€æ´**: åç»­éƒ½æ˜¯Gasæˆæœ¬ä½çš„æ˜æ–‡è®¡ç®—
- ğŸ¯ **ç»“æœå®Œæ•´**: åŒæ—¶è·å¾—è·èƒœæ•°å­—å’Œè·èƒœè€…åœ°å€

**å¯èƒ½çš„ç»“æœ**:
- **æœ‰è·èƒœè€…**: æ‰¾åˆ°å”¯ä¸€æœ€å°æ•°å­—çš„ç©å®¶
- **æ— è·èƒœè€…**: æ‰€æœ‰æ•°å­—éƒ½è¢«å¤šäººé€‰æ‹©
- **å¤šä¸ªå”¯ä¸€æ•°å­—**: é€‰æ‹©æœ€å°çš„å”¯ä¸€æ•°å­—å¯¹åº”çš„ç©å®¶

**äº‹ä»¶è§¦å‘**: `WinnerCalculationStarted`

### 5. ç»“æœæ­ç¤ºé˜¶æ®µ (Result Revelation)

**æ¸¸æˆçŠ¶æ€**: `Finished`

**ğŸ¯ ä¼˜åŒ–åçš„FHEå›è°ƒå¤„ç†**:
```solidity
// ç”± Zama é¢„è¨€æœºè°ƒç”¨ - æ–°çš„ç®€åŒ–å›è°ƒ
function callbackDecryptAllSubmissions(
    uint256 requestId,
    uint32[] memory decryptedNumbers,
    bytes[] memory signatures
) external {
    // 1. éªŒè¯ç­¾åå’Œè¯·æ±‚ID
    FHE.checkSignatures(requestId, signatures);
    
    // 2. ç»Ÿè®¡æ•°å­—é¢‘æ¬¡ï¼Œæ‰¾åˆ°å”¯ä¸€æ•°å­—
    // 3. é€‰æ‹©æœ€å°çš„å”¯ä¸€æ•°å­—
    // 4. é€šè¿‡ç´¢å¼•ç¡®å®šè·èƒœè€…
    // 5. æ›´æ–°æ¸¸æˆçŠ¶æ€å’Œç»Ÿè®¡æ•°æ®
}
```

**æ ¸å¿ƒä¼˜åŠ¿**:
- ğŸš€ **ä¸€æ­¥åˆ°ä½**: ç›´æ¥ä»è§£å¯†ç»“æœç¡®å®šæœ€ç»ˆè·èƒœè€…
- ğŸ“Š **å®Œæ•´ä¿¡æ¯**: è·èƒœæ•°å­— + è·èƒœè€…åœ°å€ + æ¸¸æˆç»“æœ
- â›½ **Gasä¼˜åŒ–**: é¿å…äº†å¤æ‚çš„FHEæ¯”è¾ƒæ“ä½œ

**å¤„ç†æµç¨‹**:
1. **éªŒè¯**: ç­¾åéªŒè¯å’Œè¯·æ±‚IDæ˜ å°„
2. **ç»Ÿè®¡**: è®¡ç®—æ¯ä¸ªæ•°å­—çš„å‡ºç°é¢‘æ¬¡  
3. **ç­›é€‰**: æ‰¾å‡ºæ‰€æœ‰å”¯ä¸€æ•°å­—ï¼ˆfrequency = 1ï¼‰
4. **é€‰æ‹©**: åœ¨å”¯ä¸€æ•°å­—ä¸­é€‰æ‹©æœ€å°å€¼
5. **ç¡®å®š**: é€šè¿‡æ•°ç»„ç´¢å¼•ç›´æ¥è·å¾—è·èƒœè€…åœ°å€
6. **æ›´æ–°**: ä¿å­˜ç»“æœå¹¶æ›´æ–°ç»Ÿè®¡æ•°æ®

**äº‹ä»¶è§¦å‘**: 
- `WinnerDetermined` (æœ‰è·èƒœè€…)
- `NoWinnerDetermined` (å¹³å±€é€€æ¬¾)

### 6. å¥–åŠ±é¢†å–é˜¶æ®µ (Prize Claiming)

**æœ‰è·èƒœè€…æƒ…å†µ**:
- è·èƒœè€…è°ƒç”¨ `claimPrize()` é¢†å–å…¨éƒ¨å¥–æ± 
- å¥–æ± ä¸€æ¬¡æ€§è½¬ç»™è·èƒœè€…
- æ¸¸æˆçŠ¶æ€å˜ä¸º `PrizeClaimed`

**å¹³å±€é€€æ¬¾æœºåˆ¶** ğŸ”„:
- å¦‚æœæ— è·èƒœè€…ï¼Œå¯åŠ¨é€€æ¬¾æœºåˆ¶
- æ¯ä¸ªå‚ä¸è€…å¯ç”³è¯· **90% å…¥åœºè´¹é€€æ¬¾**
- **10% ä½œä¸ºå¹³å°è´¹**ï¼Œç´¯ç§¯åˆ°å¹³å°è´¹æ± ä¸­
- è°ƒç”¨ `claimRefund(gameId)` ç”³è¯·é€€æ¬¾

**å¹³å°è´¹ç®¡ç†** ğŸ’°:
- åˆçº¦åˆ›å»ºè€…å¯è°ƒç”¨ `withdrawPlatformFees()` æå–ç´¯ç§¯è´¹ç”¨
- åªæœ‰åˆçº¦æ‰€æœ‰è€…æœ‰æƒé™æå–
- æ”¯æŒæ‰€æœ‰æƒè½¬ç§»åŠŸèƒ½

**ç©å®¶ç»Ÿè®¡æ›´æ–°**:
- æ¸¸æˆå‚ä¸æ¬¡æ•° (`gamesPlayed`)
- è·èƒœæ¬¡æ•° (`gamesWon`)
- æ€»å¥–é‡‘ (`totalWinnings`)

**è·èƒœå†å²è®°å½•**: è®°å½•åˆ°å…¨å±€è·èƒœè€…å†å²ä¸­

## æ¸¸æˆçŠ¶æ€æµè½¬å›¾

```mermaid
graph TD
    A[Game Creation] --> B[Open Status]
    B --> C{Player Submissions}
    C --> D{Check Conditions}
    D -->|Max Players Reached| E[Auto Trigger Calculation]
    D -->|Deadline Passed| F[Manual Trigger Available]
    D -->|Neither| C
    E --> G[Calculating Status]
    F --> G
    G --> H[FHE Winner Calculation]
    H --> I[Oracle Callback]
    I --> J[Finished Status]
    J --> K[Prize Distribution]
    K --> L[Game Complete]
```

## é‡è¦æ—¶é—´èŠ‚ç‚¹

### æˆªæ­¢æ—¶é—´å¤„ç† â°

**æˆªæ­¢å‰** (`block.timestamp <= deadline`):
- âœ… ç©å®¶å¯ä»¥æäº¤æ•°å­—
- âŒ ä¸èƒ½æ‰‹åŠ¨è§¦å‘è®¡ç®—

**æˆªæ­¢å** (`block.timestamp > deadline`):
- âŒ ç©å®¶ä¸èƒ½å†æäº¤æ•°å­—
- âœ… ä»»ä½•äººå¯ä»¥è°ƒç”¨ `findWinnerByDeadline()`
- âœ… å¦‚æœæœ‰ç©å®¶å‚ä¸ï¼Œè‡ªåŠ¨å¼€å§‹è®¡ç®—

### æœ€å¤§ç©å®¶æ•°å¤„ç† ğŸ‘¥

**æœªæ»¡å‘˜** (`playerCount < maxPlayers`):
- âœ… ç»§ç»­æ¥å—æ–°ç©å®¶
- âŒ ä¸è§¦å‘è‡ªåŠ¨è®¡ç®—

**æ»¡å‘˜** (`playerCount == maxPlayers`):
- âŒ ä¸å†æ¥å—æ–°ç©å®¶
- âœ… ç«‹å³è§¦å‘è·èƒœè€…è®¡ç®—
- âš¡ å³ä½¿æœªåˆ°æˆªæ­¢æ—¶é—´ä¹Ÿå¼€å§‹è®¡ç®—

## ç‰¹æ®Šæƒ…å†µå¤„ç†

### æ— ç©å®¶å‚ä¸
```typescript
// æˆªæ­¢æ—¶é—´åå¦‚æœæ— äººå‚ä¸
require(games[gameId].playerCount > 0, "No players in the game");
```

### é‡å¤è®¡ç®—ä¿æŠ¤
```typescript
// é˜²æ­¢é‡å¤è§¦å‘è®¡ç®—
require(games[gameId].status == GameStatus.Open, "Game is not open");
```

### å¹³å±€å¤„ç†é€»è¾‘ ğŸ¯

**è·èƒœè€…ç¡®å®šè§„åˆ™**:
1. **å”¯ä¸€æ•°å­—**: åªæœ‰ä¸€ä¸ªç©å®¶é€‰æ‹©çš„æ•°å­—
2. **æœ€å°å€¼ä¼˜å…ˆ**: å¦‚æœ‰å¤šä¸ªå”¯ä¸€æ•°å­—ï¼Œé€‰æ‹©æœ€å°çš„
3. **æ— è·èƒœè€…**: æ‰€æœ‰æ•°å­—éƒ½è¢«å¤šäººé€‰æ‹©

**å¹³å±€åœºæ™¯**:
```typescript
// æƒ…å†µ1: æ‰€æœ‰ç©å®¶é€‰æ‹©ç›¸åŒæ•°å­— â†’ æ— è·èƒœè€…ï¼Œå¯åŠ¨é€€æ¬¾
// ç©å®¶A: 5, ç©å®¶B: 5, ç©å®¶C: 5 â†’ é€€æ¬¾

// æƒ…å†µ2: å¤šä¸ªå”¯ä¸€æ•°å­— â†’ æœ€å°å€¼è·èƒœ
// ç©å®¶A: 1, ç©å®¶B: 5, ç©å®¶C: 8 â†’ ç©å®¶Aè·èƒœ(é€‰æ‹©1)

// æƒ…å†µ3: æ··åˆåœºæ™¯ â†’ æ‰¾å”¯ä¸€æœ€å°å€¼
// ç©å®¶A: 2, ç©å®¶B: 2, ç©å®¶C: 7 â†’ ç©å®¶Cè·èƒœ(7å”¯ä¸€)
```

### é€€æ¬¾å®‰å…¨æœºåˆ¶ ğŸ›¡ï¸

**é˜²é‡å¤ç”³è¯·**:
```typescript
mapping(uint256 => mapping(address => bool)) public hasClaimedRefund;
require(!hasClaimedRefund[gameId][msg.sender], "Refund already claimed");
```

**å‚ä¸éªŒè¯**:
```typescript
require(hasPlayerSubmitted[gameId][msg.sender], "You did not participate");
```

**è´¹ç”¨åˆ†é…**:
- **ç©å®¶é€€æ¬¾**: 90% å…¥åœºè´¹ (`REFUND_PERCENTAGE = 9000`)
- **å¹³å°è´¹**: 10% å…¥åœºè´¹ (è‡ªåŠ¨ç´¯ç§¯åˆ° `platformFees`)

### Mock ç¯å¢ƒé™åˆ¶
- åœ¨æµ‹è¯•ç¯å¢ƒä¸­ï¼ŒFHE å›è°ƒä¸ä¼šè‡ªåŠ¨æ‰§è¡Œ
- æ¸¸æˆçŠ¶æ€ä¼šåœç•™åœ¨ `Calculating`
- éœ€è¦æ‰‹åŠ¨æ¨¡æ‹Ÿå›è°ƒè¿‡ç¨‹è¿›è¡Œå®Œæ•´æµ‹è¯•

## ğŸš€ æŠ€æœ¯ä¼˜åŒ–äº®ç‚¹

### æ–°æ¶æ„ä¼˜åŠ¿

**åŸå§‹æ–¹æ¡ˆ vs ä¼˜åŒ–æ–¹æ¡ˆå¯¹æ¯”**:

| æ–¹é¢ | åŸå§‹æ–¹æ¡ˆ | ğŸ¯ ä¼˜åŒ–æ–¹æ¡ˆ |
|------|----------|------------|
| **FHEè§£å¯†æ¬¡æ•°** | 2æ¬¡ (æ•°å­—â†’ç´¢å¼•) | **1æ¬¡** (æ‰¹é‡è§£å¯†) |
| **FHEæ¯”è¾ƒæ“ä½œ** | å¤§é‡å¤æ‚å¾ªç¯ | **0æ¬¡** |
| **Gasæˆæœ¬** | é«˜ | **æ˜¾è‘—é™ä½** |
| **ä»£ç å¤æ‚åº¦** | å¤æ‚çš„FHEé€»è¾‘ | **ç®€æ´æ˜æ–‡è®¡ç®—** |
| **è·èƒœè€…ç¡®å®š** | å¤šæ­¥éª¤ | **ä¸€æ­¥åˆ°ä½** |

### æ ¸å¿ƒæŠ€æœ¯åˆ›æ–°

**ğŸ” æ™ºèƒ½è§£å¯†ç­–ç•¥**:
```solidity
// è€æ–¹æ¡ˆï¼šå…ˆæ‰¾æ•°å­—ï¼Œå†æ‰¾ç©å®¶ (2æ¬¡è§£å¯†)
1. è§£å¯†è·èƒœæ•°å­— â†’ 2. è§£å¯†æ‰€æœ‰æäº¤æ‰¾ç©å®¶

// æ–°æ–¹æ¡ˆï¼šç›´æ¥è§£å¯†æ‰€æœ‰ï¼Œä¸€æ¬¡è®¡ç®—å®Œæˆ (1æ¬¡è§£å¯†)  
1. æ‰¹é‡è§£å¯†æ‰€æœ‰æäº¤ â†’ 2. æ˜æ–‡è®¡ç®—ç¡®å®šè·èƒœè€…
```

**ğŸ“Š ç®—æ³•ä¼˜åŒ–**:
```javascript
// é«˜æ•ˆçš„è·èƒœè€…è®¡ç®—ç®—æ³•
function findWinner(numbers: number[]): {winner: address, number: number} {
    // O(n) æ—¶é—´å¤æ‚åº¦ï¼Œä¸€æ¬¡éå†å®Œæˆæ‰€æœ‰è®¡ç®—
    const frequency = countFrequency(numbers);      // ç»Ÿè®¡é¢‘æ¬¡
    const uniqueNumbers = getUniqueNumbers(frequency); // æ‰¾å”¯ä¸€æ•°å­—  
    const minUnique = Math.min(...uniqueNumbers);      // æ‰¾æœ€å°å€¼
    const winnerIndex = numbers.indexOf(minUnique);    // æ‰¾è·èƒœè€…ç´¢å¼•
    return { winner: players[winnerIndex], number: minUnique };
}
```

## æŸ¥è¯¢åŠŸèƒ½

### æ¸¸æˆæŸ¥è¯¢
- `getAllGames()`: è·å–æ‰€æœ‰æ¸¸æˆ
- `getActiveGames()`: è·å–æ´»è·ƒæ¸¸æˆ
- `getGamesByStatus(status)`: æŒ‰çŠ¶æ€ç­›é€‰æ¸¸æˆ
- `getGameSummary(gameId)`: è·å–æ¸¸æˆæ‘˜è¦
- `canFinalizeGame(gameId)`: æ£€æŸ¥æ˜¯å¦å¯ä»¥ç»“æŸæ¸¸æˆ

### ç©å®¶ç»Ÿè®¡
- `getPlayerStats(player)`: è·å–ç©å®¶ç»Ÿè®¡
- `getPlayerGames(player)`: è·å–ç©å®¶å‚ä¸çš„æ¸¸æˆ
- `getLeaderboard(limit)`: è·å–æ’è¡Œæ¦œ
- `getWinnerHistory(limit)`: è·å–è·èƒœå†å²

### å¹³å±€ä¸é€€æ¬¾æŸ¥è¯¢
- `canClaimRefund(gameId, player)`: æ£€æŸ¥æ˜¯å¦å¯ç”³è¯·é€€æ¬¾
- `hasClaimedRefund(gameId, player)`: æ£€æŸ¥æ˜¯å¦å·²ç”³è¯·é€€æ¬¾
- `getPlatformFees()`: è·å–å½“å‰å¹³å°è´¹ä½™é¢

### å¹³å°ç®¡ç†
- `owner()`: è·å–åˆçº¦æ‰€æœ‰è€…
- `withdrawPlatformFees()`: æå–å¹³å°è´¹ï¼ˆä»…æ‰€æœ‰è€…ï¼‰
- `transferOwnership(newOwner)`: è½¬ç§»æ‰€æœ‰æƒï¼ˆä»…æ‰€æœ‰è€…ï¼‰

## å®‰å…¨è€ƒè™‘

### è¾“å…¥éªŒè¯
- æˆ¿é—´åé•¿åº¦é™åˆ¶ (1-64å­—ç¬¦)
- æ•°å­—èŒƒå›´éªŒè¯ (æœ€å¤§255èŒƒå›´)
- æœ€å°ç©å®¶æ•°é™åˆ¶ (â‰¥2)
- å…¥åœºè´¹ç²¾ç¡®åŒ¹é…

### é˜²é‡æ”¾æ”»å‡»
- ç©å®¶æäº¤çŠ¶æ€è·Ÿè¸ª
- æ¸¸æˆçŠ¶æ€ä¸¥æ ¼æ§åˆ¶
- æ—¶é—´æˆ³éªŒè¯

### FHE å®‰å…¨
- é›¶çŸ¥è¯†è¯æ˜éªŒè¯
- é¢„è¨€æœºæƒé™æ§åˆ¶
- åŠ å¯†æ•°æ®å®Œæ•´æ€§

### å¹³å±€é€€æ¬¾å®‰å…¨ ğŸ”’
- **é‡å…¥æ”»å‡»é˜²æŠ¤**: ä½¿ç”¨ Check-Effects-Interactions æ¨¡å¼
- **é‡å¤ç”³è¯·é˜²æŠ¤**: `hasClaimedRefund` æ˜ å°„è·Ÿè¸ª
- **æƒé™éªŒè¯**: åªæœ‰å‚ä¸è€…å¯ç”³è¯·é€€æ¬¾
- **æ•°å­¦ç²¾åº¦**: ä½¿ç”¨ `PERCENTAGE_BASE = 10000` ä¿è¯ç²¾åº¦

### å¹³å°è´¹å®‰å…¨
- **æ‰€æœ‰æƒæ§åˆ¶**: åªæœ‰åˆçº¦æ‰€æœ‰è€…å¯æå–
- **é›¶åœ°å€ä¿æŠ¤**: é˜²æ­¢è½¬ç§»æ‰€æœ‰æƒåˆ°é›¶åœ°å€
- **ä½™é¢æ£€æŸ¥**: æå–å‰éªŒè¯ä½™é¢å­˜åœ¨

### ç”Ÿäº§ç¯å¢ƒè€ƒè™‘
- **Gasä¼˜åŒ–**: FHEæ“ä½œæ¯”æ™®é€šæ“ä½œæ¶ˆè€—æ›´å¤šGas
- **äº‹ä»¶ç›‘å¬**: å®¢æˆ·ç«¯éœ€ç›‘å¬ `NoWinnerDetermined` å’Œ `RefundClaimed` äº‹ä»¶
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯æ¶ˆæ¯å’Œå›æ»šæœºåˆ¶

---

*æœ¬æ–‡æ¡£åŸºäº UniqueNumberGameFactory.sol åˆçº¦å’Œç›¸å…³æµ‹è¯•æ–‡ä»¶åˆ†æç¼–å†™ã€‚*